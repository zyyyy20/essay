<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blog.dao.ArticleMapper">
    
    <resultMap id="BaseResultMap" type="com.blog.entity.Article">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="summary" property="summary" jdbcType="VARCHAR"/>
        <result column="author_id" property="authorId" jdbcType="INTEGER"/>
        <result column="category_id" property="categoryId" jdbcType="INTEGER"/>
        <result column="view_count" property="viewCount" jdbcType="INTEGER"/>
        <result column="published" property="published" jdbcType="BOOLEAN"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="author_name" property="authorName" jdbcType="VARCHAR"/>
        <result column="category_name" property="categoryName" jdbcType="VARCHAR"/>
    </resultMap>
    
    <select id="findPublishedArticles" resultMap="BaseResultMap">
        SELECT a.id, a.title, a.content, a.summary, a.author_id, a.category_id, 
               a.view_count, a.published, a.created_at, a.updated_at,
               u.username as author_name, c.name as category_name
        FROM articles a
        LEFT JOIN users u ON a.author_id = u.id
        LEFT JOIN categories c ON a.category_id = c.id
        WHERE a.published = TRUE
        ORDER BY a.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="findPublishedArticlesByCategory" resultMap="BaseResultMap">
        SELECT a.id, a.title, a.content, a.summary, a.author_id, a.category_id, 
               a.view_count, a.published, a.created_at, a.updated_at,
               u.username as author_name, c.name as category_name
        FROM articles a
        LEFT JOIN users u ON a.author_id = u.id
        LEFT JOIN categories c ON a.category_id = c.id
        WHERE a.published = TRUE AND a.category_id = #{categoryId}
        ORDER BY a.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="findPublishedArticlesByTag" resultMap="BaseResultMap">
        SELECT DISTINCT a.id, a.title, a.content, a.summary, a.author_id, a.category_id, 
               a.view_count, a.published, a.created_at, a.updated_at,
               u.username as author_name, c.name as category_name
        FROM articles a
        LEFT JOIN users u ON a.author_id = u.id
        LEFT JOIN categories c ON a.category_id = c.id
        LEFT JOIN article_tags at ON a.id = at.article_id
        WHERE a.published = TRUE AND at.tag_id = #{tagId}
        ORDER BY a.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="searchPublishedArticles" resultMap="BaseResultMap">
        SELECT a.id, a.title, a.content, a.summary, a.author_id, a.category_id, 
               a.view_count, a.published, a.created_at, a.updated_at,
               u.username as author_name, c.name as category_name
        FROM articles a
        LEFT JOIN users u ON a.author_id = u.id
        LEFT JOIN categories c ON a.category_id = c.id
        WHERE a.published = TRUE AND a.title LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY a.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="findById" resultMap="BaseResultMap">
        SELECT a.id, a.title, a.content, a.summary, a.author_id, a.category_id, 
               a.view_count, a.published, a.created_at, a.updated_at,
               u.username as author_name, c.name as category_name
        FROM articles a
        LEFT JOIN users u ON a.author_id = u.id
        LEFT JOIN categories c ON a.category_id = c.id
        WHERE a.id = #{id}
    </select>
    
    <select id="findAll" resultMap="BaseResultMap">
        SELECT a.id, a.title, a.content, a.summary, a.author_id, a.category_id, 
               a.view_count, a.published, a.created_at, a.updated_at,
               u.username as author_name, c.name as category_name
        FROM articles a
        LEFT JOIN users u ON a.author_id = u.id
        LEFT JOIN categories c ON a.category_id = c.id
        ORDER BY a.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <select id="countPublished" resultType="long">
        SELECT COUNT(*) FROM articles WHERE published = TRUE
    </select>
    
    <select id="countPublishedByCategory" resultType="long">
        SELECT COUNT(*) FROM articles WHERE published = TRUE AND category_id = #{categoryId}
    </select>
    
    <select id="countPublishedByTag" resultType="long">
        SELECT COUNT(DISTINCT a.id) 
        FROM articles a
        LEFT JOIN article_tags at ON a.id = at.article_id
        WHERE a.published = TRUE AND at.tag_id = #{tagId}
    </select>
    
    <select id="countSearch" resultType="long">
        SELECT COUNT(*) FROM articles WHERE published = TRUE AND title LIKE CONCAT('%', #{keyword}, '%')
    </select>
    
    <select id="countAll" resultType="long">
        SELECT COUNT(*) FROM articles
    </select>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO articles (title, content, summary, author_id, category_id, published, view_count)
        VALUES (#{title}, #{content}, #{summary}, #{authorId}, #{categoryId}, #{published}, 0)
    </insert>
    
    <update id="update">
        UPDATE articles
        SET title = #{title}, content = #{content}, summary = #{summary}, 
            category_id = #{categoryId}, published = #{published}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>
    
    <delete id="deleteById">
        DELETE FROM articles WHERE id = #{id}
    </delete>
    
    <update id="incrementViewCount">
        UPDATE articles SET view_count = view_count + 1 WHERE id = #{id}
    </update>
</mapper>